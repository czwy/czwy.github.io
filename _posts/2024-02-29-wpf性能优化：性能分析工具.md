---
categories:
- WPF
date: 2024-02-29 08:43
last_modified_at: 2025-03-23 12:51:48 +0800
mtime: 2025-03-23 12:51:48
tags:
- WPF
- 性能
title: WPF性能优化：性能分析工具
---

在硬件性能不断提升的现在，软件性能依旧是开发人员关注的重点。不同类型的程序关注的具体性能指标有所不同，服务器程序注重吞吐量，游戏引擎追求渲染效率，桌面程序则关注内存消耗以及界面加载效率和流畅性。当我们需要进行性能优化时，首先需要找到性能瓶颈。本文将介绍两个WPF性能优化分析工具：`内存使用率`和`应用程序时间线`的使用。

## 内存使用率
内存使用率是Visual Studio中集成的诊断工具之一，适用于.Net程序查找内存泄漏或者低效内存适用情况。

默认情况下，调试程序时诊断工具窗口会自动开启停靠在右侧或者底部。如果因为个人适用习惯关闭了诊断工具窗口，可以通过顶部菜单栏找到“调试”—>“窗口”—>“显示诊断窗口”或者快捷键`Ctrl+Alt+F2`打开诊断工具窗口。

诊断工具窗口可以查看程序运行过程CPU和内存消耗的变化，鼠标悬浮在进程内存消耗图上时，会显示任意时间点的内存消耗。

要查看内存使用情况时，可以在诊断工具窗口的内存使用情况选项卡点击“截取快照”按钮。通常我们会在内存显著增加前后各截取一次内存快照，然后对比两次快照中对象和堆大小的差异。
![Diagnostic](https://eb19df4.webp.li/2025/02/Diagnostic.gif)


上图中显示了两次截图快照的时间、对象个数和堆中的字节数。其中第二条快照信息中对象个数和堆大小中括号内的数值是相对于第一条快照中的变化。对象个数和堆大小这两列中的数值是以超链接形式显示，点击后可以打开选定快照的堆视图。显示了快照捕获的完整的对象集，包括了各类型对象的个数，对象实例大小和非独占大小。点击表头可以对选定列进行排序。
![heapView](https://eb19df4.webp.li/2025/02/heapView.png)

并且可以通过堆试图左上角类型筛选器快速查找指定类型的内存信息。下图中显示内存中增加了1800个Student对象实例，占用大约158KB内存。
![HeapViewFilter](https://eb19df4.webp.li/2025/02/HeapViewFilter.png)

## 应用程序时间线
应用程序时间线工具集成在Visual Studio中的性能探测器中，用于查找XAML应用程序交互相关的性能问题。该工具提供了详细的视图显示XAML应用程序（目前不支持Avalonia）资源使用情况，可以查看UI线程使用率，可视化吞吐量，UI元素解析、布局及呈现、网络及磁盘I/O所耗费的时间。

使用应用程序时间线工具时，只需单击“调试”—>“性能探测器”或者使用快捷键`Alt+F2`，在“XXX.diagsession 窗口”中看到分析工具。勾选应用程序时间线后点击“开始”按钮进行性能数据收集。需要停止分析时，点击分析窗口左上角的“停止收集”按钮，等待一会儿就会生成详细的视图。在诊断会话窗口的分析工具列表中有个“内存使用率”，勾选后也可以分析内存使用情况（上一小节已详细介绍）。
![image](https://img2024.cnblogs.com/blog/3056716/202402/3056716-20240228204337407-1445098011.gif)

### UI线程使用率
UI线程使用率以柱状图的形式呈现每个时间点UI线程使用情况，并用不同色块区分ui元素解析、布局、呈现、I/O、应用程序代码、Xaml其他使用UI线程的占比。UI线程使用率过高的时间点可能表示应用程序响应能力较差，是性能优化需要关注的地方。
![image](https://img2024.cnblogs.com/blog/3056716/202402/3056716-20240228204603391-1506481607.png)

### 可视吞吐量(FPS)
“可视吞吐量(FPS)” 折线图显示了应用程序的 UI线程和复合线程上的每秒帧数 (FPS)，较低的帧速率也意味着应用程序响应能力较差。
![image](https://img2024.cnblogs.com/blog/3056716/202402/3056716-20240228204637971-208154616.png)

### 时间线详细信息
时间线详细信息视图呈现了每个时间点占用CPU的UI框架子系统和系统组件以及它们占用时间。
主要包括以下几类：
* 解析：分析XAML文件并创建对象或者元素所消耗的时间。
* 布局：计算所有需要布局的元素的大小和位置耗用的时间（即在`Arrange`、`Measure`、`ApplyTemplate`、`ArrangeOverride`和`MeasureOverride`中所用的时间）。在大型应用程序中，可能会同时在屏幕上显示数千个元素。此显示可能会导致UI帧速率降低以及应用程序响应能力相应地变差。
* 呈现：在屏幕上绘制XAML元素所耗用的时间。
* I/O：从本地磁盘或从通过Microsoft Windows Internet (WinINet) API访问的网络资源中检索数据所耗用的时间。
* 应用程序代码：执行与分析或布局无关的应用程序（用户）代码所耗用的时间。
* Xaml其他：执行 XAML 运行时代码所耗用的时间。

时间线详细信息视图分为左中右三列。左侧显示事件名称，绝大部分事件是发生在UI线程上，这些事件名称前有一个紫色线条标记，非UI线程上的事件则无标记。中间一列顶部显示时间轴，下边显示每个事件的色块标记（与UI线程使用率中色块颜色一致）、持续总计时间（自身和子元素持续时间的总和）和自身持续时间，鼠标悬浮在元素上会显示自身持续时间和事件开始时间。右侧一列则显示选中事件的详细信息描述。
![image](https://img2024.cnblogs.com/blog/3056716/202402/3056716-20240228204801714-12417090.png)

上边示例中，UI线程使用率过高，耗时最长的是布局，开始于6.91秒，总耗时6.56秒，涉及33237个元素，其原因就是TreeView没有开启虚拟化，一次性把所有的数据都渲染出来，导致UI响应差。通过这个分析找到性能瓶颈，就可以有的放矢进行优化。这里只需开启虚拟化即可，现实开发中导致性能瓶颈的原因多种多样，需结合实际情况优化解决。

## 小结
`内存使用率`和`应用程序时间线`是WPF开发过程中不可或缺的两个有效工具，此外，Snoop以及Visual Studio中的实时可视化树、实时属性资源管理器、XAML实时预览、XAML绑定失败、辅助功能检查等工具也能提高开发调试效率。

## 参考
https://devblogs.microsoft.com/visualstudio/analyze-cpu-memory-while-debugging/
https://learn.microsoft.com/zh-cn/visualstudio/profiling/application-timeline?view=vs-2022